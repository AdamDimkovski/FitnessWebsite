<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Exercises</title>

  <link rel="icon" type="image/x-icon" href="images/favicon.png">
  <link rel="stylesheet" href="style-exercise.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="exercise-data.js"></script>

  <style>
    body {
      margin: 0;
      background: radial-gradient(circle at top, #222 0%, #111 60%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: #fff;
    }

    .selector-wrapper {
      max-width: 1000px;
      margin: 40px auto;
      padding: 24px;
      background: rgba(40,40,40,0.95);
      border-radius: 18px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.6);
      animation: fadeUp 0.5s ease;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .selector-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .selector-title {
      font-size: 1.9rem;
      font-weight: 800;
    }

    .back-btn {
      background: #333;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s ease;
    }

    .back-btn:hover {
      background: #444;
      transform: translateX(-2px);
    }

    .search-bar {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid #444;
      background: #1c1c1c;
      color: #fff;
      font-size: 1rem;
      margin-bottom: 18px;
    }

    .search-bar:focus {
      outline: none;
      border-color: #f9d423;
      box-shadow: 0 0 8px rgba(249,212,35,0.5);
    }

    .category-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 18px;
    }

    .category-tab {
      padding: 10px 18px;
      border-radius: 999px;
      background: #333;
      font-weight: 700;
      cursor: pointer;
      transition: 0.25s ease;
    }

    .category-tab.active {
      background: linear-gradient(135deg, #f9d423, #ff9f1a);
      color: #000;
      box-shadow: 0 0 10px rgba(249,212,35,0.6);
    }

    .exercise-list {
      max-height: 420px;
      overflow-y: auto;
      padding: 12px;
      border-radius: 14px;
      background: #1b1b1b;
      border: 1px solid #333;
    }

    .exercise-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-radius: 12px;
      background: #2a2a2a;
      margin-bottom: 10px;
      cursor: pointer;
      border: 1px solid #444;
      transition: 0.25s ease;
      font-weight: 600;
    }

    .exercise-item:hover {
      transform: scale(1.02);
      border-color: #f9d423;
      box-shadow: 0 0 12px rgba(249,212,35,0.35);
    }

    .exercise-item.selected {
      background: linear-gradient(135deg, #3aa856, #2e7d32);
      border-color: #3aa856;
      box-shadow: 0 0 12px rgba(58,168,86,0.6);
    }

    .pr-tag {
      font-size: 0.85rem;
      opacity: 0.85;
    }

    .done-btn {
      margin-top: 20px;
      width: 100%;
      padding: 16px;
      font-size: 1.15rem;
      font-weight: 800;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #ff4e50, #f9d423);
      color: #000;
      cursor: pointer;
      transition: 0.3s ease;
    }

    .done-btn:hover {
      transform: scale(1.03);
      box-shadow: 0 0 16px rgba(249,212,35,0.6);
    }
  </style>
</head>

<body>

<section class="selector-wrapper">
  <div class="selector-header">
    <div class="selector-title">Select Exercises</div>
    <button class="back-btn" id="goBackBtn">‚Üê Back</button>
  </div>

  <input
    type="text"
    id="exerciseSearch"
    class="search-bar"
    placeholder="Search exercises..."
  >

  <div class="category-tabs" id="categoryTabs"></div>

  <div class="exercise-list" id="exerciseList"></div>

  <button class="done-btn" id="doneBtn">Done</button>
</section>

<script>
  let currentCategory = Object.keys(EXERCISES)[0];
  let prMap = {};

  async function loadPRs() {
    const user = auth.currentUser;
    if (!user) return;

    const snapshot = await db
      .collection("users")
      .doc(user.uid)
      .collection("personalRecords")
      .get();

    snapshot.forEach(doc => {
      prMap[doc.id] = doc.data().weight;
    });

    filterExercises();
  }

  function renderCategories() {
    const tabs = document.getElementById("categoryTabs");
    tabs.innerHTML = "";

    Object.keys(EXERCISES).forEach(cat => {
      const tab = document.createElement("div");
      tab.className = "category-tab" + (cat === currentCategory ? " active" : "");
      tab.textContent = cat;

      tab.onclick = () => {
        currentCategory = cat;
        renderCategories();
        filterExercises();
      };

      tabs.appendChild(tab);
    });
  }

  function renderExerciseList(list) {
    const container = document.getElementById("exerciseList");
    container.innerHTML = "";

    const stored = JSON.parse(localStorage.getItem("selectedExercises")) || [];

    list.forEach(name => {
      const item = document.createElement("div");
      item.className = "exercise-item";

      const isSelected = stored.some(ex => ex.name === name);
      if (isSelected) item.classList.add("selected");

      item.innerHTML = `
        <span>${name}</span>
        ${prMap[name] ? `<span class="pr-tag">PR ${prMap[name]} kg</span>` : ""}
      `;

      item.onclick = () => {
        const idx = stored.findIndex(ex => ex.name === name);
        if (idx >= 0) {
          // deselect
          stored.splice(idx, 1);
          localStorage.setItem("selectedExercises", JSON.stringify(stored));
          item.classList.remove("selected");
          return;
        }

        // select
        stored.push({ name, type: getExerciseType(name), sets: [] });
        localStorage.setItem("selectedExercises", JSON.stringify(stored));
        item.classList.add("selected");
      };

      container.appendChild(item);
    });
  }

  function filterExercises() {
    const term = document.getElementById("exerciseSearch").value.toLowerCase();
    const filtered = EXERCISES[currentCategory].filter(ex =>
      ex.toLowerCase().includes(term)
    );
    renderExerciseList(filtered);
  }

  document.getElementById("exerciseSearch").addEventListener("input", filterExercises);
  document.getElementById("goBackBtn").onclick = () => location.href = "exercise.html";
  document.getElementById("doneBtn").onclick = () => location.href = "exercise.html";

  auth.onAuthStateChanged(user => {
    if (user) loadPRs();
  });

  renderCategories();
  filterExercises();
</script>

</body>
</html>
