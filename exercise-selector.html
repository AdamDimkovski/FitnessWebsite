<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Select Exercises</title>

  <link rel="icon" type="image/x-icon" href="images/favicon.png">
  <link rel="stylesheet" href="style-exercise.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="exercise-data.js"></script>
  <script src="script.js"></script>

  <style>
    body {
      background: #1a1a1a;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #fff;
      overflow-x: hidden;
    }

    .selector-container {
      width: 90%;
      margin: 40px auto;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      animation: fadeIn 0.4s ease;
      position: relative;
      z-index: 10;
      isolation: isolate;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      margin-top: 0;
      font-size: 1.8rem;
      font-weight: 700;
      text-align: center;
    }

    .back-btn {
      margin-bottom: 15px;
      padding: 10px 16px;
      background: #3a3a3a;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .back-btn:hover {
      background: #555;
      transform: scale(1.03);
    }

    .search-bar {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #555;
      background: #1d1d1d;
      color: #fff;
      margin-bottom: 20px;
      font-size: 1rem;
      transition: 0.2s ease;
    }

    .search-bar:focus {
      outline: none;
      border-color: #f9d423;
      box-shadow: 0 0 6px #f9d423;
    }

    .category-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      justify-content: center;
    }

    .category-tab {
      padding: 10px 18px;
      background: #444;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.25s ease;
      font-weight: 600;
    }

    .category-tab:hover {
      background: #555;
      transform: translateY(-2px);
    }

    .category-tab.active {
      background: #f9d423;
      color: #000;
      transform: scale(1.05);
    }

    .exercise-list {
      position: relative;
      z-index: 5;
      max-height: 450px;
      overflow-y: auto;
      background: #1f1f1f;
      padding: 15px;
      border-radius: 12px;
      border: 1px solid #333;
    }

    .exercise-item {
      padding: 14px;
      background: #2b2b2b;
      border-radius: 10px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: 0.25s ease;
      font-weight: 600;
      border: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .exercise-item:hover {
      background: #3a3a3a;
      transform: scale(1.02);
      border-color: #f9d423;
      box-shadow: 0 0 8px rgba(249,212,35,0.4);
    }

    .exercise-item.selected {
      background: #4caf50 !important;
      border-color: #4caf50 !important;
      color: #fff;
      transform: scale(1.02);
      box-shadow: 0 0 10px rgba(76,175,80,0.5);
    }

    .pr-small {
      color: #bbb;
      font-size: 0.85rem;
      margin-left: 10px;
    }

    .done-btn {
      margin-top: 20px;
      padding: 14px 20px;
      background: linear-gradient(to right, #ff4e50, #f9d423);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      font-size: 1.1rem;
      transition: 0.25s ease;
    }

    .done-btn:hover {
      transform: scale(1.04);
      box-shadow: 0 0 10px rgba(249,212,35,0.5);
    }
  </style>
</head>

<body>

  <section class="selector-container">
    <h2>Select Exercises</h2>

    <button class="back-btn" id="goBackBtn">‚Üê Back</button>

    <input type="text" id="exerciseSearch" class="search-bar" placeholder="Search exercises...">

    <div class="category-tabs" id="categoryTabs"></div>

    <div class="exercise-list" id="exerciseList"></div>

    <button class="done-btn" id="doneBtn">Done</button>
  </section>

  <script>

    let currentCategory = "Chest";
    let prMap = {};

    async function loadPRs() {
      const user = auth.currentUser;
      if (!user) return;

      const snapshot = await db.collection("users")
        .doc(user.uid)
        .collection("personalRecords")
        .get();

      snapshot.forEach(doc => {
        prMap[doc.id] = doc.data().weight;
      });

      filterExercises();
    }

    function renderCategories() {
      const tabs = document.getElementById("categoryTabs");
      tabs.innerHTML = "";

      Object.keys(EXERCISES).forEach(cat => {
        const tab = document.createElement("div");
        tab.className = "category-tab" + (cat === currentCategory ? " active" : "");
        tab.textContent = cat;

        tab.onclick = () => {
          currentCategory = cat;
          renderCategories();
          filterExercises();
        };

        tabs.appendChild(tab);
      });
    }

    document.getElementById("goBackBtn").onclick = () => {
      window.location.href = "exercise.html";
    };

    function renderExerciseList(list) {
      const container = document.getElementById("exerciseList");
      container.innerHTML = "";

      const stored = JSON.parse(localStorage.getItem("selectedExercises")) || [];

      list.forEach(name => {
        const item = document.createElement("div");
        item.className = "exercise-item";

        const prText = prMap[name] ? `<span class="pr-small">(${prMap[name]}kg)</span>` : "";

        item.innerHTML = `
          <span>${name}</span>
          ${prText}
        `;

        if (stored.some(ex => ex.name === name)) {
          item.classList.add("selected");
        }

        item.onclick = () => {
          addExercise(name);
          item.classList.add("selected");
        };

        container.appendChild(item);
      });
    }

    function addExercise(name) {
      let stored = JSON.parse(localStorage.getItem("selectedExercises")) || [];

      if (stored.some(ex => ex.name === name)) return;

      stored.push({
        name,
        type: getExerciseType(name),
        sets: []
      });

      localStorage.setItem("selectedExercises", JSON.stringify(stored));
    }

    function filterExercises() {
      const search = document.getElementById("exerciseSearch").value.toLowerCase();
      const list = EXERCISES[currentCategory].filter(ex =>
        ex.toLowerCase().includes(search)
      );
      renderExerciseList(list);
    }

    document.getElementById("doneBtn").onclick = () => {
      window.location.href = "exercise.html";
    };

    auth.onAuthStateChanged(user => {
      if (user) loadPRs();
    });

    renderCategories();
    filterExercises();

    document.getElementById("exerciseSearch").addEventListener("input", filterExercises);
  </script>

</body>

</html>